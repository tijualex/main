{% extends 'base.html' %}

{% block content %}

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Order ID</th>
            <th>User</th>
            <th>Design ID</th>
            <th>Shipping Address ID</th>
            <th>Order Date</th>
            <th>Total Price</th>
            <th>Order Status</th>
            <th>Payment Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
        <tr>
            <td>{{ order.order_id }}</td>
            <td>{{ order.user.username }}</td>
            <td>{{ order.design.design_id }}</td>
            <td>{{ order.delivery_address.address_id }}</td>
            <td>{{ order.order_date }}</td>
            <td>${{ order.total_price }}</td>
            <td id="order-status-{{ order.order_id }}">{{ order.get_order_status_display }}</td>
            <td>
                {% if order.payment_status %}
                <span class="text-success">Paid</span>
                {% else %}
                <span class="text-danger">Unpaid</span>
                {% endif %}
            </td>
            <td>
                <div class="btn-group" role="group">
                    {% if order.order_status == 'processing' %}
                    <button type="button" class="btn btn-warning btn-sm"
                        onclick="changeOrderStatus('{{ order.order_id }}', 'shipped', '{{ order.order_status }}')">Mark as Shipped</button>
                        
                    {% elif order.order_status == 'shipped' %}
                    <button type="button" class="btn btn-success btn-sm"
                        onclick="changeOrderStatus('{{ order.order_id }}', 'delivered', '{{ order.order_status }}')" id="mark-delivered-btn-{{ order.order_id }}">Mark as Delivered</button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    function changeOrderStatus(orderId, newStatus, currentStatus) {
        // Check if the current status is 'shipped' before allowing 'delivered'
        if (currentStatus === 'shipped' || (currentStatus === 'processing' && newStatus === 'shipped')) {
            // Send an AJAX request to update the order status
            // You'll need to implement this AJAX request using Django's views and URLs
            // Example using jQuery:
            $.ajax({
                url: '/update_order_status/',
                method: 'POST',
                data: {
                    'order_id': orderId,
                    'new_status': newStatus,
                    'csrfmiddlewaretoken': '{{ csrf_token }}' // Include CSRF token
                },
                success: function (data) {
                    // Handle success response
                    if (data.success) {
                        // Update the UI to reflect the new status
                        var statusCell = $('#order-status-' + orderId);
                        statusCell.text(data.new_status);

                        // Disable the "Mark as Delivered" button if the status is not "Shipped"
                        if (data.new_status !== 'shipped') {
                            $('#mark-delivered-btn-' + orderId).prop('disabled', true);
                        } else {
                            $('#mark-delivered-btn-' + orderId).prop('disabled', false);
                        }
                    } else {
                        // Handle any errors or display a message to the user
                        console.error('Error updating order status.');
                    }
                },
                error: function (error) {
                    // Handle error response
                    console.error('AJAX request failed.');
                }
            });
        }
    }
</script>

{% endblock %}
